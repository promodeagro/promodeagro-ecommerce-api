service: promodeAgro-ecommerce-api

frameworkVersion: "4"

provider:
  name: aws
  stage: ${opt:stage, 'local'}
  region: ap-south-1
  runtime: nodejs18.x
  # Auto-create IAM role with appropriate permissions for Lambda execution
  # For production, ensure you have proper AWS credentials configured
  versionFunctions: false
  timeout: 29
  logs:
      httpApi: true
  # IAM role with DynamoDB permissions for all Lambda functions
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:BatchGetItem
            - dynamodb:BatchWriteItem
          Resource:
            - "arn:aws:dynamodb:${self:provider.region}:*:table/*"
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource:
            - "arn:aws:logs:${self:provider.region}:*:*"
  httpApi:
    cors:
      allowedOrigins:
        - "*"
      allowedHeaders:
        - "*"
      allowedMethods:
        - OPTIONS
        - GET
        - POST
        - PUT
        - DELETE
  environment:
    STAGE: ${self:provider.stage}
    NODE_ENV: ${self:provider.stage}
    # Note: AWS_REGION, AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY are reserved by AWS Lambda
    # They are automatically set by AWS and cannot be overridden
    REGION: ${self:provider.region}
    # For production (prod stage), use real AWS DynamoDB (no DYNAMODB_ENDPOINT set)
    # For local development, use LocalStack (set DYNAMODB_ENDPOINT via .env.local)
    DYNAMODB_ENDPOINT: ${env:DYNAMODB_ENDPOINT, ''}
    LOCALSTACK_ENDPOINT: ${env:LOCALSTACK_ENDPOINT, ''}
    # Production table names (matching Python CLI)
    PRODUCTS_TABLE: ${env:PRODUCTS_TABLE, 'Products'}
    ORDER_TABLE_NAME: ${env:ORDER_TABLE_NAME, 'Orders'}
    CUSTOMER_TABLE_NAME: ${env:CUSTOMER_TABLE_NAME, 'Customers'}
    CATEGORY_TABLE_NAME: ${env:CATEGORY_TABLE_NAME, 'Category_management'}
    UNIT_TABLE_NAME: ${env:UNIT_TABLE_NAME, 'Unit_management'}
    STOCK_ADJUSTMENT_TABLE: ${env:STOCK_ADJUSTMENT_TABLE, 'Stock_adjustment'}
    PINCODE_TABLE_NAME: ${env:PINCODE_TABLE_NAME, 'Pincode_management'}
    DELIVERY_TYPES_TABLE: ${env:DELIVERY_TYPES_TABLE, 'Delivery_types'}
    DELIVERY_SLOTS_TABLE: ${env:DELIVERY_SLOTS_TABLE, 'Delivery_slots'}
    JWT_SECRET: ${env:JWT_SECRET, 'change-me-in-production'}

functions:
  - ${file(products/function.yml)}

  # - ${file(RBAC/function.yml)}
  # - ${file(loginwithotp/function.yml)}

  # - ${file(OrderBills/function.yml)}
  # - ${file(Users/function.yml)}
  # - ${file(inventory/function.yml)}
  # - ${file(Login/function.yml)}
  # - ${file(Customer/function.yml)}
  # - ${file(order/function.yml)}
  # - ${file(payment/function.yml)}
  # - ${file(stepFunctions/function.yml)}
  # - ${file(cart/function.yml)}
  # - ${file(category/function.yml)}
  # - ${file(deliverySlots/function.yml)}
  # - ${file(offers/function.yml)}
  # - ${file(reviews/function.yml)}
  # - ${file(wishlist/function.yml)}
  # - ${file(sales/function.yml)}
  # - ${file(saveForLater/function.yml)}
  # - ${file(payment/function.yml)}
  # - ${file(userSession/function.yml)}

  
  # - ${file(webhooks/function.yml)}
# plugins:
#   - serverless-offline  # Disabled to speed up packaging for production deployment

# Optimized packaging configuration for faster deployment
# Single package with aggressive exclusions is faster than individual packaging
package:
  individually: false  # Single package for all functions (faster deployment)
  exclude:
    # AWS SDKs (excluded - built-in to Lambda runtime)
    - node_modules/aws-sdk/**  # v2 SDK (built-in)
    - node_modules/@aws-sdk/**  # v3 SDK (built-in)
    - node_modules/aws-lambda-ric/**
    
    # Large dev dependencies (not needed in production)
    - node_modules/puppeteer-core/**  # Browser automation - Lambda can't use it
    - node_modules/puppeteer/**  # Browser automation - Lambda can't use it
    - node_modules/chromium-bidi/**  # Puppeteer dependency
    - node_modules/@img/**  # Image processing (use Lambda layer instead)
    - node_modules/sharp/**  # Image processing (use Lambda layer instead)
    - node_modules/pdf-lib/**  # PDF handling (move to layer if needed)
    - node_modules/@babel/**  # Transpiler (not needed in production)
    - node_modules/@types/**  # TypeScript types (dev only)
    - node_modules/rxjs/**  # Check if really needed
    - node_modules/class-validator/**  # Validation library
    - node_modules/libphonenumber-js/**  # Phone number validation
    - node_modules/timezone-support/**  # Timezone handling
    
    # Test and dev tools
    - node_modules/jest/**
    - node_modules/serverless/**
    - node_modules/serverless-offline/**
    - tests/**
    - products/tests/**
    - "**/*.test.js"
    - "**/*.spec.js"
    - "**/*.d.ts"  # TypeScript definition files
    - "**/*.spec.ts"
    
    # Git and version control
    - .git/**
    - .gitignore
    - .gitattributes
    - .github/**
    
    # Environment and config files
    - .env
    - .env.local
    - .env.*.local
    - .env.example
    - .envrc
    
    # Build artifacts
    - dist/**
    - build/**
    - .next/**
    - .cache/**
    - .turbo/**
    
    # Coverage and reports
    - coverage/**
    - .nyc_output/**
    - htmlcov/**
    - reports/**
    
    # Serverless framework artifacts
    - .serverless/**
    - .serverless_plugins/**
    - serverless.yml.bak
    
    # Documentation
    - README.md
    - "*.md"
    - docs/**
    - doc/**
    
    # Node internals
    - node_modules/.bin/**
    - node_modules/*/test/**
    - node_modules/*/tests/**
    - node_modules/*/example/**
    - node_modules/*/examples/**
    - node_modules/*/.github/**
    - node_modules/*/.git/**
    - node_modules/*/README.md
    - node_modules/*/LICENSE
    - "node_modules/**/*.md"
    
    # Package manager files
    - package-lock.json
    - yarn.lock
    - pnpm-lock.yaml
    
    # OS files
    - .DS_Store
    - Thumbs.db
    - .env.local
    - .vscode/**
    - .idea/**

# Custom settings
custom:
  # These settings help reduce bundle size further if needed
  serverless-offline:
    httpPort: 4000
    lambdaPort: 3001
    skipCacheInvalidation: true

